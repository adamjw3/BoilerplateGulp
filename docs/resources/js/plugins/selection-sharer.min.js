!function(e){var t=function(t){var o=this;"string"==typeof(t=t||{})&&(t={elements:t}),this.sel=null,this.textSelection="",this.htmlSelection="",this.appId=e('meta[property="fb:app_id"]').attr("content")||e('meta[property="fb:app_id"]').attr("value"),this.url2share=e('meta[property="og:url"]').attr("content")||e('meta[property="og:url"]').attr("value")||window.location.href,this.getSelectionText=function(e){var t="",n="";if((e=e||window.getSelection()).rangeCount){for(var r=document.createElement("div"),i=0,a=e.rangeCount;i<a;++i)r.appendChild(e.getRangeAt(i).cloneContents());n=r.textContent,t=r.innerHTML}return o.textSelection=n,o.htmlSelection=t||n,n},this.selectionDirection=function(e){var t=e||window.getSelection(),o=document.createRange();if(!t.anchorNode)return 0;o.setStart(t.anchorNode,t.anchorOffset),o.setEnd(t.focusNode,t.focusOffset);var n=o.collapsed?"backward":"forward";return o.detach(),n},this.show=function(e){setTimeout(function(){var t=window.getSelection(),n=o.getSelectionText(t);if(!t.isCollapsed&&n&&n.length>10&&n.match(/ /)){var r=t.getRangeAt(0).getBoundingClientRect().top-5+o.getPosition().y-o.$popover.height(),i=0;if(e)i=e.pageX;else{var a=t.anchorNode.parentNode;i+=a.offsetWidth/2;do{i+=a.offsetLeft}while(a=a.offsetParent)}switch(o.selectionDirection(t)){case"forward":i-=o.$popover.width();break;case"backward":i+=o.$popover.width();break;default:return}o.$popover.removeClass("anim").css("top",r+10).css("left",i).show(),setTimeout(function(){o.$popover.addClass("anim").css("top",r)},0)}},10)},this.hide=function(e){o.$popover.hide()},this.smart_truncate=function(e,t){if(!e||!e.length)return e;var o=e.length>t,n=o?e.substr(0,t-1):e;return n=o?n.substr(0,n.lastIndexOf(" ")):n,o?n+"...":n},this.getRelatedTwitterAccounts=function(){var t=[],o=e('meta[name="twitter:creator"]').attr("content")||e('meta[name="twitter:creator"]').attr("value");o&&t.push(o);for(var n=document.getElementsByTagName("a"),r=0,i=n.length;r<i;r++)if(n[r].attributes.href&&"string"==typeof n[r].attributes.href.value){var a=n[r].attributes.href.value.match(/^https?:\/\/twitter\.com\/([a-z0-9_]{1,20})/i);a&&a.length>1&&-1==["widgets","intent"].indexOf(a[1])&&t.push(a[1])}return t.length>0?t.join(","):""},this.shareTwitter=function(e){e.preventDefault();var t="“"+o.smart_truncate(o.textSelection.trim(),114)+"”",n="http://twitter.com/intent/tweet?text="+encodeURIComponent(t)+"&related="+o.relatedTwitterAccounts+"&url="+encodeURIComponent(window.location.href);o.viaTwitterAccount&&t.length<114-o.viaTwitterAccount.length&&(n+="&via="+o.viaTwitterAccount);var r=screen.width/2-320,i=screen.height/2-220-100;return window.open(n,"share_twitter","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=640, height=440, top="+i+", left="+r),o.hide(),!1},this.shareFacebook=function(e){e.preventDefault();var t=o.htmlSelection.replace(/<p[^>]*>/gi,"\n").replace(/<\/p>|  /gi,"").trim(),n="https://www.facebook.com/dialog/feed?app_id="+o.appId+"&display=popup&caption="+encodeURIComponent(t)+"&link="+encodeURIComponent(o.url2share)+"&href="+encodeURIComponent(o.url2share)+"&redirect_uri="+encodeURIComponent(o.url2share),r=screen.width/2-320,i=screen.height/2-220-100;window.open(n,"share_facebook","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=640, height=440, top="+i+", left="+r)},this.render=function(){o.$popover=e('<div class="selectionSharer" id="selectionSharerPopover" style="position:absolute;">  <div id="selectionSharerPopover-inner">    <ul>      <li><a class="action tweet" href="" title="Share this selection on Twitter" target="_blank">Tweet</a></li>      <li><a class="action facebook" href="" title="Share this selection on Facebook" target="_blank">Facebook</a></li>    </ul>  </div>  <div class="selectionSharerPopover-clip"><span class="selectionSharerPopover-arrow"></span></div></div>'),o.$popover.find("a.tweet").click(o.shareTwitter),o.$popover.find("a.facebook").click(o.shareFacebook),e("body").append(o.$popover),o.appId&&o.url2share&&e(".selectionSharer a.facebook").css("display","inline-block")},this.setElements=function(t){"string"==typeof t&&(t=e(t)),o.$elements=t instanceof e?t:e(t),o.$elements.mouseup(o.show).mousedown(o.hide).addClass("selectionShareable"),document.onselectionchange=o.selectionChanged},this.selectionChanged=function(e){},this.getPosition=function(){var e=void 0!==window.pageXOffset,t="CSS1Compat"===(document.compatMode||"");return{x:e?window.pageXOffset:t?document.documentElement.scrollLeft:document.body.scrollLeft,y:e?window.pageYOffset:t?document.documentElement.scrollTop:document.body.scrollTop}},this.render(),t.elements&&this.setElements(t.elements)};e.fn.selectionSharer=function(){return(new t).setElements(this),this},"function"==typeof define?define(function(){return t.load=function(e,o,n,r){(new t).setElements("p"),n()},t}):window.SelectionSharer=t}(jQuery);